#!/usr/bin/env python3
"""
–û–±–Ω–æ–≤–ª—è–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –í–°–ï–• —É—á–∞—Å—Ç–∫–æ–≤ (–∫—Ä–æ–º–µ —Å–µ–ª—å—Ö–æ–∑ –∏ –ø—Ä–æ–º) –Ω–∞–ø—Ä—è–º—É—é –≤ Supabase.
–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å —É—á–µ—Ç–æ–º —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏ –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å–µ–ª–∫–∞.
"""

import os
import random
import sys
from pathlib import Path
from collections import defaultdict

# Load .env file
env_path = Path(__file__).parent.parent / '.env.local'
if env_path.exists():
    for line in env_path.read_text().splitlines():
        line = line.strip()
        if line and not line.startswith('#') and '=' in line:
            key, _, value = line.partition('=')
            os.environ.setdefault(key.strip(), value.strip())

try:
    from supabase import create_client, Client
except ImportError:
    print("‚ùå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ supabase: pip install supabase")
    sys.exit(1)

# Import village info
from villages_info import get_village_info, VILLAGES_INFO

# === –ù–ê–°–¢–†–û–ô–ö–ò ===
SUPABASE_URL = os.environ.get('NEXT_PUBLIC_SUPABASE_URL')
SUPABASE_KEY = os.environ.get('SUPABASE_SERVICE_ROLE_KEY')
REGION_NAME = "–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"

# –ò—Å–∫–ª—é—á–∞–µ–º—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∑–µ–º–ª–∏
EXCLUDED_STATUSES = ['–°–µ–ª—å—Ö–æ–∑', '–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å', '–ü—Ä–æ–º', '–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π', '–°/—Ö', '–°–•–ù']

if not SUPABASE_URL or not SUPABASE_KEY:
    print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è NEXT_PUBLIC_SUPABASE_URL –∏–ª–∏ SUPABASE_SERVICE_ROLE_KEY")
    sys.exit(1)

# === –ë–ê–ó–ê –§–†–ê–ó (–ö–û–ù–°–¢–†–£–ö–¢–û–†) ===

# –ó–∞–≥–æ–ª–æ–≤–∫–∏ - —Å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –ø–ª–æ—â–∞–¥–∏
headers_templates = [
    "–û—Ç–ª–∏—á–Ω–∞—è –∑–µ–º–ª—è {area} —Å–æ—Ç. –ø–æ–¥ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –¥–æ–º–∞",
    "–£—á–∞—Å—Ç–æ–∫ {area} —Å–æ—Ç. –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–æ–¥–∞–∂ ‚Äî –≤—ã–≥–æ–¥–Ω–∞—è —Ü–µ–Ω–∞",
    "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ {area} —Å–æ—Ç. –≤ {district_short}",
    "–ó–µ–º–µ–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ {area} —Å–æ—Ç. ({land_status}) –æ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞",
    "–†–æ–≤–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ {area} —Å–æ—Ç. –≤ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ–π –ª–æ–∫–∞—Ü–∏–∏",
    "–£—á–∞—Å—Ç–æ–∫ {area} —Å–æ—Ç–æ–∫ ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞",
    "–í—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: {area} —Å–æ—Ç–æ–∫ –≤ {village}",
    "–í–∞—à —É—á–∞—Å—Ç–æ–∫ {area} —Å–æ—Ç. —Ä—è–¥–æ–º —Å –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥–æ–º",
    "–ó–µ–º–ª—è {area} —Å–æ—Ç. –ø–æ–¥ –ò–ñ–° ‚Äî –≥–æ—Ç–æ–≤–∞ –∫ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É",
    "–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ {area} —Å–æ—Ç. –ø–æ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–π —Ü–µ–Ω–µ",
]

# –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã
locations_universal = [
    "–ù–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –Ω–æ–≤–æ–π –Ω–∞—Ä–µ–∑–∫–µ, —Å–æ—Å–µ–¥–∏ —É–∂–µ –Ω–∞—á–∏–Ω–∞—é—Ç —Å—Ç—Ä–æ–∏—Ç—å—Å—è.",
    "–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω –≤ –Ω–æ–≤–æ–º –º–∞—Å—Å–∏–≤–µ, —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è.",
    "–£—á–∞—Å—Ç–æ–∫ –≤ —Å–≤–µ–∂–µ–π –Ω–∞—Ä–µ–∑–∫–µ, –≤–æ–∫—Ä—É–≥ —Å–≤–æ–±–æ–¥–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.",
    "–ù–æ–≤—ã–π –∫–≤–∞—Ä—Ç–∞–ª –∑–∞—Å—Ç—Ä–æ–π–∫–∏, –æ—Ç–ª–∏—á–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞.",
    "–õ–æ–∫–∞—Ü–∏—è –≤ —Ä–∞–∑–≤–∏–≤–∞—é—â–µ–π—Å—è —á–∞—Å—Ç–∏ –ø–æ—Å–µ–ª–∫–∞, –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ —Ä–æ—Å—Ç–∞ —Ü–µ–Ω—ã.",
    "–¢–∏—Ö–∞—è —É–ª–∏—Ü–∞, –º–∏–Ω–∏–º—É–º –ø—Ä–æ–µ–∑–∂–∞—é—â–∏—Ö –º–∞—à–∏–Ω.",
    "–£–¥–æ–±–Ω—ã–π –ø–æ–¥—ä–µ–∑–¥ —Å –≥–ª–∞–≤–Ω–æ–π –¥–æ—Ä–æ–≥–∏.",
    "–°–æ–ª–Ω–µ—á–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞, —É—á–∞—Å—Ç–æ–∫ —Ö–æ—Ä–æ—à–æ –æ—Å–≤–µ—â–µ–Ω.",
    "–í—Ç–æ—Ä–æ–π —Ä—è–¥ –æ—Ç –¥–æ—Ä–æ–≥–∏ ‚Äî —Ç–∏—Ö–æ, –Ω–æ –≤—ã–µ–∑–¥ —É–¥–æ–±–Ω—ã–π.",
    "–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–π –∫–≤–∞—Ä—Ç–∞–ª —Å –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞—Å—Ç—Ä–æ–π–∫–æ–π.",
]

# –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —É—á–∞—Å—Ç–∫–∞ - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ
features_universal = [
    "–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ —É—á–∞—Å—Ç–∫–∞, —É–¥–æ–±–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–æ–º –∏ –ø–∞—Ä–∫–æ–≤–∫—É.",
    "–°—É—Ö–æ–π, —Ä–æ–≤–Ω—ã–π —Ä–µ–ª—å–µ—Ñ, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–æ–≥–æ—Å—Ç–æ—è—â–µ–π –ø–æ–¥—Å—ã–ø–∫–∏.",
    "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å—Ç–∞—Ä—ã–µ —Å—Ç—Ä–æ–µ–Ω–∏—è –∏ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç—ã ‚Äî —á–∏—Å—Ç–∞—è –ø–ª–æ—â–∞–¥–∫–∞.",
    "–ó–µ–º–ª—è –ø–ª–æ–¥–æ—Ä–æ–¥–Ω–∞—è (–±—ã–≤—à–∏–µ —Å–µ–ª—å—Ö–æ–∑—É–≥–æ–¥—å—è), –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è —Å–∞–¥–∞.",
    "–ù–µ—Ç –æ–±—Ä–µ–º–µ–Ω–µ–Ω–∏–π –∏ –¥–æ–ª–≥–æ–≤, –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã.",
    "–ü–æ–¥—ä–µ–∑–¥–Ω—ã–µ –ø—É—Ç–∏ ‚Äî –≥—Ä—É–Ω—Ç–æ–≤–∞—è –¥–æ—Ä–æ–≥–∞, –ø—Ä–æ–µ–∑–¥ –∫—Ä—É–≥–ª—ã–π –≥–æ–¥.",
    "–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ: –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–ª–∏–Ω–∏—è —Ä—è–¥–æ–º).",
    "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞–ª–æ–≥–∏ –∏ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∑–µ–º–ª–∏.",
    "–ü–æ–∫—É–ø–∫–∞ –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ —Å–∫—Ä—ã—Ç—ã—Ö –∫–æ–º–∏—Å—Å–∏–π –∏ –ø–µ—Ä–µ–ø–ª–∞—Ç.",
    "–ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Ä–∞–Ω–Ω–µ–º —ç—Ç–∞–ø–µ.",
    "–ú–µ–∂–µ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ, –≥—Ä–∞–Ω–∏—Ü—ã –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã.",
    "–£—á–∞—Å—Ç–æ–∫ –±–µ–∑ —É–∫–ª–æ–Ω–∞, —ç–∫–æ–Ω–æ–º–∏—è –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–µ.",
    "–ì—Ä—É–Ω—Ç–æ–≤—ã–µ –≤–æ–¥—ã –≥–ª—É–±–æ–∫–æ, –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å —Å–µ–ø—Ç–∏–∫ –±–µ–∑ –ø—Ä–æ–±–ª–µ–º.",
    "–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä ‚Äî –º–µ–Ω—å—à–µ –Ω–∞–ª–æ–≥–æ–≤, –º–µ–Ω—å—à–µ –∫–æ—Å–∏—Ç—å —Ç—Ä–∞–≤—É.",
]

# –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ (–±—É–¥—É—Ç –¥–æ–ø–æ–ª–Ω—è—Ç—å—Å—è –∏–∑ villages_info)
benefits_universal = [
    "–†—ã–Ω–æ–∫ –∑–µ–º–ª–∏ –∑–¥–µ—Å—å —Ä–∞—Å—Ç–µ—Ç ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è.",
    "–í—ã–≥–æ–¥–Ω–µ–µ, —á–µ–º —Ä–∞—Å–∫—Ä—É—á–µ–Ω–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è: —Ü–µ–Ω–∞ –Ω–∏–∂–µ, –∞ –µ—Ö–∞—Ç—å —Å—Ç–æ–ª—å–∫–æ –∂–µ.",
    "–≠–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —á–∏—Å—Ç–æ–µ –º–µ—Å—Ç–æ, —Ç–∏—à–∏–Ω–∞ –∏ —Å–≤–µ–∂–∏–π –≤–æ–∑–¥—É—Ö.",
    "–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –≥–æ—Ä–æ–¥ —Ä–∞—Å—Ç–µ—Ç –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç—É —Å—Ç–æ—Ä–æ–Ω—É.",
    "–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å –¥–µ—à–µ–≤–æ –∏ –ø—Ä–æ–¥–∞—Ç—å –¥–æ—Ä–æ–∂–µ —á–µ—Ä–µ–∑ –≥–æ–¥.",
    "–°–ø–æ–∫–æ–π–Ω—ã–π —Ä–∞–π–æ–Ω –¥–ª—è —Å–µ–º–µ–π–Ω–æ–π –∂–∏–∑–Ω–∏.",
    "–ù–∏–∫–∞–∫–∏—Ö –≥–æ—Ä–æ–¥—Å–∫–∏—Ö –ø—Ä–æ–±–æ–∫ –∏ —à—É–º–∞.",
    "–û—Ç–ª–∏—á–Ω–∞—è —ç–∫–æ–ª–æ–≥–∏—è, —á–∏—Å—Ç—ã–π –≤–æ–∑–¥—É—Ö.",
]

# CTA - –ø—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é
ctas = [
    "–ì–æ—Ç–æ–≤ –ø–æ–∫–∞–∑–∞—Ç—å —É—á–∞—Å—Ç–æ–∫ –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è.",
    "–ó–≤–æ–Ω–∏—Ç–µ, –ø–æ–∫–∞–∂—É –≤ –ª—é–±–æ–π –¥–µ–Ω—å!",
    "–î–æ–∫—É–º–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã, –±—ã—Å—Ç—Ä—ã–π –≤—ã—Ö–æ–¥ –Ω–∞ —Å–¥–µ–ª–∫—É.",
    "–£—Å–ø–µ–π—Ç–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–µ.",
    "–ü–∏—à–∏—Ç–µ, —Å–∫–∏–Ω—É —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ.",
    "–ë–µ–∑ —Å–∫—Ä—ã—Ç—ã—Ö –∫–æ–º–∏—Å—Å–∏–π, –ø—Ä—è–º–∞—è –ø—Ä–æ–¥–∞–∂–∞.",
    "–ó–≤–æ–Ω–∏—Ç–µ —Å–µ–π—á–∞—Å, –∫ —Å–µ–∑–æ–Ω—É —Ü–µ–Ω—ã –≤—ã—Ä–∞—Å—Ç—É—Ç.",
    "–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É, –æ—Ç–≤–µ—á—É –ø–æ–¥—Ä–æ–±–Ω–æ.",
]


def format_area(area_sotok: float) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø–ª–æ—â–∞–¥—å: 7.0 -> '7', 7.88 -> '7.88'"""
    if area_sotok is None:
        return "6"
    if area_sotok == int(area_sotok):
        return str(int(area_sotok))
    return f"{area_sotok:.2f}".rstrip('0').rstrip('.')


def format_price(price: float) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ü–µ–Ω—É: 400000 -> '400 000'"""
    if price is None:
        return "–¥–æ–≥–æ–≤–æ—Ä–Ω–∞—è"
    return f"{int(price):,}".replace(',', ' ')


def get_district_short(district: str) -> str:
    """–°–æ–∫—Ä–∞—â–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–π–æ–Ω–∞."""
    if not district:
        return "–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏"
    return district.replace(" —Ä–∞–π–æ–Ω", "").replace(" –≥–æ—Ä–æ–¥—Å–∫–æ–π –æ–∫—Ä—É–≥", "")


def generate_unique_description(plot: dict, village_info: dict, used_combinations: set) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —É—á–∞—Å—Ç–∫–∞.
    """
    area = format_area(plot.get('area_sotok'))
    cadastral = plot.get('cadastral_number', '')
    price = plot.get('price')
    land_status = plot.get('land_status', '–ò–ñ–°')
    village = plot.get('location', '–ø–æ—Å–µ–ª–æ–∫')
    district = plot.get('district', '')
    district_short = get_district_short(district)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–µ–ª–∫–µ
    distance_km = village_info.get('distance_km', 20)
    drive_time = village_info.get('drive_time', '20-30 –º–∏–Ω—É—Ç')
    village_features = village_info.get('features', [])
    village_infra = village_info.get('infrastructure', [])
    village_benefits = village_info.get('benefits', [])
    
    max_attempts = 100
    for _ in range(max_attempts):
        # –í—ã–±–æ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–∞
        head_template = random.choice(headers_templates)
        head = head_template.format(
            area=area,
            district_short=district_short,
            land_status=land_status,
            village=village
        )
        
        # –í—ã–±–æ—Ä —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è
        loc = random.choice(locations_universal)
        
        # –í—ã–±–æ—Ä 2 —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
        feat1 = random.choice(features_universal)
        feat2 = random.choice([f for f in features_universal if f != feat1])
        
        # –í—ã–±–æ—Ä –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤: 1 –∏–∑ village_benefits + 2 –∏–∑ universal
        all_benefits = village_benefits + benefits_universal
        ben1 = random.choice(all_benefits)
        ben2 = random.choice([b for b in all_benefits if b != ben1])
        ben3 = random.choice([b for b in all_benefits if b not in [ben1, ben2]])
        
        # –í—ã–±–æ—Ä CTA
        cta = random.choice(ctas)
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
        combo_key = (head_template, loc, feat1, feat2, ben1, ben2, ben3, cta)
        
        if combo_key not in used_combinations:
            used_combinations.add(combo_key)
            break
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º
    distance_str = f"–î–æ –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥–∞ {distance_km} –∫–º ({drive_time} –Ω–∞ –º–∞—à–∏–Ω–µ)."
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
    infra_str = ""
    if village_infra:
        infra_item = random.choice(village_infra)
        infra_str = f"\n{infra_item}"
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ü–µ–Ω—É
    price_str = f"{format_price(price)} ‚ÇΩ" if price else "–¥–æ–≥–æ–≤–æ—Ä–Ω–∞—è"
    
    # –°–ë–û–†–ö–ê –¢–ï–ö–°–¢–ê
    full_desc = f"""**–û–ø–∏—Å–∞–Ω–∏–µ**

{head}

üìç **{village}**, {district}, {REGION_NAME}
üìê –ü–ª–æ—â–∞–¥—å: **{area} —Å–æ—Ç–æ–∫** ({land_status})
üè∑Ô∏è –ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä: **{cadastral}**
üí∞ –¶–µ–Ω–∞: **{price_str}**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:**
{loc}
{distance_str}{infra_str}

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —É—á–∞—Å—Ç–∫–∞:**
‚Ä¢ {feat1}
‚Ä¢ {feat2}

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
‚Ä¢ {ben1}
‚Ä¢ {ben2}
‚Ä¢ {ben3}

{cta}"""

    return full_desc


def main():
    print("=" * 60)
    print("–û–ë–ù–û–í–õ–ï–ù–ò–ï –û–ü–ò–°–ê–ù–ò–ô –í–°–ï–• –£–ß–ê–°–¢–ö–û–í")
    print("=" * 60)
    
    print(f"\n–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase...")
    supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É—á–∞—Å—Ç–∫–∏
    print(f"–ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–∫–æ–≤ –∏–∑ –ë–î...")
    
    # Supabase –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º 1000 –∑–∞–ø–∏—Å–µ–π, –Ω—É–∂–Ω–æ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞—Ç—å
    all_plots = []
    offset = 0
    limit = 1000
    
    while True:
        response = supabase.table('land_plots').select(
            'id, location, district, land_status, area_sotok, price, cadastral_number'
        ).range(offset, offset + limit - 1).execute()
        
        batch = response.data
        if not batch:
            break
        
        all_plots.extend(batch)
        print(f"  –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {len(all_plots)} –∑–∞–ø–∏—Å–µ–π...")
        
        if len(batch) < limit:
            break
        offset += limit
    
    print(f"–í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {len(all_plots)} —É—á–∞—Å—Ç–∫–æ–≤")
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º: –∏—Å–∫–ª—é—á–∞–µ–º —Å–µ–ª—å—Ö–æ–∑ –∏ –ø—Ä–æ–º
    plots = [
        p for p in all_plots 
        if p.get('land_status') not in EXCLUDED_STATUSES
        and '—Å–µ–ª—å—Ö–æ–∑' not in str(p.get('land_status', '')).lower()
        and '–ø—Ä–æ–º' not in str(p.get('land_status', '')).lower()
    ]
    
    print(f"–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–±–µ–∑ —Å–µ–ª—å—Ö–æ–∑/–ø—Ä–æ–º): {len(plots)} —É—á–∞—Å—Ç–∫–æ–≤")
    
    if not plots:
        print("‚ùå –£—á–∞—Å—Ç–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
        return
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø–æ—Å–µ–ª–∫–∞–º –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    by_location = defaultdict(list)
    for p in plots:
        loc = p.get('location') or '–ë–µ–∑ –ø–æ—Å–µ–ª–∫–∞'
        by_location[loc].append(p)
    
    print(f"–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Å–µ–ª–∫–æ–≤: {len(by_location)}")
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏–π
    used_combinations = set()
    updated = 0
    errors = 0
    
    print(f"\n–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏–π...")
    
    for i, plot in enumerate(plots, 1):
        village = plot.get('location', '')
        district = plot.get('district', '')
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–µ–ª–∫–µ
        village_info = get_village_info(village, district)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
        new_desc = generate_unique_description(plot, village_info, used_combinations)
        
        try:
            supabase.table('land_plots').update({'description': new_desc}).eq('id', plot['id']).execute()
            updated += 1
        except Exception as e:
            print(f"  ‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è {plot['id']}: {e}")
            errors += 1
        
        if i % 100 == 0:
            print(f"  –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {i}/{len(plots)} (–æ–±–Ω–æ–≤–ª–µ–Ω–æ: {updated}, –æ—à–∏–±–æ–∫: {errors})")
    
    print(f"\n{'=' * 60}")
    print(f"‚úÖ –ì–û–¢–û–í–û!")
    print(f"   –í—Å–µ–≥–æ —É—á–∞—Å—Ç–∫–æ–≤: {len(plots)}")
    print(f"   –û–±–Ω–æ–≤–ª–µ–Ω–æ: {updated}")
    print(f"   –û—à–∏–±–æ–∫: {errors}")
    print(f"   –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π —Ñ—Ä–∞–∑: {len(used_combinations)}")
    print(f"{'=' * 60}")
    
    # –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø–æ—Å–µ–ª–∫–∞–º
    print(f"\n–¢–æ–ø-10 –ø–æ—Å–µ–ª–∫–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —É—á–∞—Å—Ç–∫–æ–≤:")
    sorted_locs = sorted(by_location.items(), key=lambda x: -len(x[1]))
    for loc, plist in sorted_locs[:10]:
        print(f"  {loc}: {len(plist)} —É—á.")


if __name__ == "__main__":
    main()
